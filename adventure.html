<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adventure Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- -------- Leaflet (f√ºr Karte) √ºber CDN -------- -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+6EL23QJd0bYpPpmmJcQjU23Y5HkBvcwMmWt0xy3Y="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-QVGGfXXm4Zj+knqnm/sw+5Zyj8vfR3VjX0cljFKpUU8="
    crossorigin=""
  ></script>

  <style>
    /* ------ Grund-Layout ------ */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    header button {
      background: #e67e22;
      border: none;
      padding: 0.4rem 0.8rem;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
    }
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* Linke Seite: Karte + Stations-Liste */
    #sidebar {
      width: 300px;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    /* Karte */
    #map {
      flex: 1;
    }
    /* Liste aller Stationen */
    #stationListContainer {
      max-height: 200px;
      overflow-y: auto;
      background: #ecf0f1;
      padding: 0.5rem;
    }
    #stationListContainer h2 {
      margin-top: 0;
      font-size: 1rem;
    }
    .station-entry {
      padding: 0.3rem 0.5rem;
      margin-bottom: 0.2rem;
      border: 1px solid #bdc3c7;
      border-radius: 3px;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .station-entry.locked {
      background: #f5b7b1;
      cursor: not-allowed;
    }
    .station-entry.completed {
      background: #a3e4d7;
      text-decoration: line-through;
    }

    /* Rechte Seite: Content (Stationen) */
    #content {
      flex: 2;
      padding: 1rem;
      overflow-y: auto;
    }

    /* Unterer Bereich: Inventar + Punkte */
    footer {
      background: #f4f6f7;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    #inventory {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #inventory span {
      background: #d5dbdb;
      padding: 0.3rem 0.6rem;
      border-radius: 3px;
      font-size: 0.9rem;
    }
    #points {
      font-weight: bold;
    }

    /* Allgemeine Buttons & Texte */
    button {
      padding: 0.5rem 1rem;
      background: #2980b9;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    input[type="text"] {
      padding: 0.4rem;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      height: 80px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <!-- ========================= HEADER ========================= -->
  <header>
    <h1 id="gameTitle">Adventure Play</h1>
    <div>
      <!-- JSON-Input: Hier f√ºgst du das aus generator.html kopierte JSON ein -->
      <button id="btnLoadJson">üé≤ JSON laden</button>
      <button id="btnReset">‚ôªÔ∏è Reset</button>
    </div>
  </header>

  <!-- ========================= MAIN-LAYOUT ========================= -->
  <main>
    <!-- --- SIDEBAR: Karte + Stations-Liste --- -->
    <div id="sidebar">
      <div id="map"></div>
      <div id="stationListContainer">
        <h2>Stationen</h2>
        <!-- Dynamisch: Liste aller Stationen -->
      </div>
    </div>

    <!-- --- CONTENT: Hier werden Stationen angezeigt --- -->
    <div id="content">
      <p>Bitte lade zuerst dein JSON, um das Abenteuer zu starten.</p>
    </div>
  </main>

  <!-- ========================= FOOTER: Inventar + Punkte ========================= -->
  <footer>
    <div id="inventory">
      <strong>Inventar:</strong>
      <!-- Dynamisch angezeigte Items -->
    </div>
    <div id="points">
      Punkte: <span id="pointsValue">0</span>
    </div>
  </footer>


  <!-- ========================= JAVASCRIPT ========================= -->
  <script>
  /*************************************************************************
   * Adventure Play
   * 
   * - Liest dein JSON ein (Struktur siehe unten).
   * - Rendert Karte mit Leaflet (wenn Koordinaten angegeben).
   * - Zeigt alle Stationen (gelockt, freigeschaltet, erledigt).
   * - Zeigt Content (Info, R√§tsel, Item) in der Content-Area an.
   * - Verwalte Inventar, Punkte, Fortschritt (localStorage).
   *
   * JSON-Struktur (Beispiel):
   * {
   *   "title": "...",
   *   "description": "...",
   *   "stations": [
   *     {
   *       "id": "start",
   *       "type": "info",
   *       "text": "Willkommen!",
   *       "optional": false,
   *       "itemsGiven": ["key1"],
   *       "requiresItems": [],
   *       "lat": 47.3769,
   *       "lng": 8.5417
   *     },
   *     {
   *       "id": "door1",
   *       "type": "riddle",
   *       "text": "Was ist 2+2?",
   *       "answer": "4",
   *       "optional": false,
   *       "itemsGiven": [],
   *       "requiresItems": ["key1"],
   *       "lat": 47.3810,
   *       "lng": 8.5470
   *     },
   *     {
   *       "id": "gem",
   *       "type": "item",
   *       "itemName": "Magischer Edelstein",
   *       "itemDesc": "Ein Stein, der in der Dunkelheit gl√ºht.",
   *       "optional": true,
   *       "itemsGiven": ["gem1"],
   *       "requiresItems": [],
   *       "lat": null,
   *       "lng": null
   *     }
   *   ]
   * }
   *************************************************************************/

    // ========================= Globals & DOM-Referenzen =========================
    let gameData = null;           // Das eingelesene JSON-Objekt
    let stationStates = {};        // Status pro Station: "locked" | "unlocked" | "completed"
    let inventory = [];            // Array aller Item-IDs im Inventar
    let points = 0;                // Spieler-Punkte

    const gameTitleEl     = document.getElementById("gameTitle");
    const btnLoadJson     = document.getElementById("btnLoadJson");
    const btnReset        = document.getElementById("btnReset");
    const contentDiv      = document.getElementById("content");
    const stationListDiv  = document.getElementById("stationListContainer");
    const inventoryDiv    = document.getElementById("inventory");
    const pointsValueEl   = document.getElementById("pointsValue");
    let leafletMap        = null;  // Leaflet-Map-Instanz
    let markersById       = {};    // Map von stationId -> Leaflet Marker

    // ========================= Funktionen f√ºr localStorage =========================
    function saveProgress() {
      localStorage.setItem("adv_gameData", JSON.stringify(gameData));
      localStorage.setItem("adv_stationStates", JSON.stringify(stationStates));
      localStorage.setItem("adv_inventory", JSON.stringify(inventory));
      localStorage.setItem("adv_points", points.toString());
    }
    function loadProgress() {
      const savedData = localStorage.getItem("adv_gameData");
      if (!savedData) return false;
      gameData       = JSON.parse(savedData);
      stationStates  = JSON.parse(localStorage.getItem("adv_stationStates")  || "{}");
      inventory      = JSON.parse(localStorage.getItem("adv_inventory")      || "[]");
      points         = parseInt(localStorage.getItem("adv_points") || "0", 10);
      return true;
    }
    function clearProgress() {
      localStorage.removeItem("adv_gameData");
      localStorage.removeItem("adv_stationStates");
      localStorage.removeItem("adv_inventory");
      localStorage.removeItem("adv_points");
      location.reload();
    }

    // ========================= Hilfsfunktion: Check, ob Station freigeschaltet ist =========================
    function isStationUnlocked(st) {
      // Falls bereits komplett erledigt, ist sie ‚Äûcompleted‚Äú ‚Äì aber trotzdem ‚Äûunlocked‚Äú
      if (stationStates[st.id] === "completed") return true;
      // Pr√ºfe, ob alle ben√∂tigten Items im Inventar sind
      for (const req of (st.requiresItems || [])) {
        if (!inventory.includes(req)) return false;
      }
      // Alle Voraussetzungen erf√ºllt -> freigeschaltet
      return true;
    }

    // ========================= Initialize Leaflet-Map =========================
    function initMap() {
      // Karte nur einmal initialisieren
      if (leafletMap) return;
      leafletMap = L.map("map").setView([47.3769, 8.5417], 13); // Standard-Koordinaten (z.B. Z√ºrich)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(leafletMap);
    }

    // ========================= Stationen-Liste rendern =========================
    function renderStationList() {
      stationListDiv.innerHTML = "<h2>Stationen</h2>";
      gameData.stations.forEach(st => {
        const state = stationStates[st.id] || "locked";
        // Bestimme aktuellen Status dynamisch:
        const unlocked = isStationUnlocked(st);
        const completed = stationStates[st.id] === "completed";
        const entry = document.createElement("div");
        entry.classList.add("station-entry");
        if (!unlocked)      entry.classList.add("locked");
        else if (completed) entry.classList.add("completed");
        entry.innerHTML = `
          <span>${st.id}</span>
          <span>${completed ? "‚úÖ" : unlocked ? "‚û§" : "üîí"}</span>
        `;
        // Klick nur, wenn unlockt UND nicht completed
        if (unlocked && !completed) {
          entry.addEventListener("click", () => openStation(st.id));
        }
        stationListDiv.appendChild(entry);
      });
    }

    // ========================= Marker auf der Karte platzieren =========================
    function placeMarkers() {
      // Erstelle Marker nur, wenn Koordinaten existieren
      gameData.stations.forEach(st => {
        if (st.lat !== null && st.lng !== null) {
          const marker = L.marker([st.lat, st.lng]).addTo(leafletMap);
          marker.bindPopup(`<strong>${st.id}</strong>`);
          markersById[st.id] = marker;
        }
      });
    }

    // ========================= Station √∂ffnen / rendern =========================
    function openStation(stationId) {
      const st = gameData.stations.find(s => s.id === stationId);
      if (!st) return;

      // Content-Bereich leeren
      contentDiv.innerHTML = "";

      // √úberschrift
      const h2 = document.createElement("h2");
      h2.textContent = `Station: ${st.id}`;
      contentDiv.appendChild(h2);

      // Typ-spezifisch rendern
      if (st.type === "info") {
        renderInfoStation(st);
      }
      else if (st.type === "riddle") {
        renderRiddleStation(st);
      }
      else if (st.type === "item") {
        renderItemStation(st);
      }
    }

    // ========================= Render-Funktionen pro Stationstyp =========================

    /** Info-Station: Text anzeigen + Weiter-Button **/
    function renderInfoStation(st) {
      const p = document.createElement("p");
      p.textContent = st.text;
      contentDiv.appendChild(p);

      const btn = document.createElement("button");
      btn.textContent = "‚úîÔ∏è Weiter";
      btn.addEventListener("click", () => finishStation(st));
      contentDiv.appendChild(btn);
    }

    /** R√§tsel-Station: Frage + Input + Feedback **/
    function renderRiddleStation(st) {
      const p = document.createElement("p");
      p.textContent = st.text;
      contentDiv.appendChild(p);

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Deine Antwort...";
      contentDiv.appendChild(input);

      const feedback = document.createElement("p");
      feedback.style.color = "red";
      contentDiv.appendChild(feedback);

      const btn = document.createElement("button");
      btn.textContent = "Antwort pr√ºfen";
      btn.addEventListener("click", () => {
        if (input.value.trim().toLowerCase() === st.answer.trim().toLowerCase()) {
          finishStation(st);
        } else {
          feedback.textContent = "‚ùå Falsch, versuche es nochmal!";
        }
      });
      contentDiv.appendChild(btn);
    }

    /** Item-Station: Item ins Inventar legen + Weiter-Button **/
    function renderItemStation(st) {
      const p = document.createElement("p");
      p.textContent = `Du hast ein Item gefunden: ${st.itemName}`;
      contentDiv.appendChild(p);

      if (st.itemDesc) {
        const desc = document.createElement("p");
        desc.style.fontStyle = "italic";
        desc.textContent = st.itemDesc;
        contentDiv.appendChild(desc);
      }

      const btn = document.createElement("button");
      btn.textContent = "‚úîÔ∏è Item einsammeln";
      btn.addEventListener("click", () => finishStation(st));
      contentDiv.appendChild(btn);
    }

    // ========================= Station abschlie√üen =========================
    function finishStation(st) {
      // 1) Punkte vergeben (z. B. 10 Punkte pro Pflichtstation, 5 Punkte pro optional)
      const gained = st.optional ? 5 : 10;
      points += gained;

      // 2) Items ins Inventar legen (wenn definiert)
      for (const itm of (st.itemsGiven || [])) {
        if (!inventory.includes(itm)) {
          inventory.push(itm);
        }
      }

      // 3) Station als ‚Äûcompleted‚Äú markieren
      stationStates[st.id] = "completed";

      // 4) UI updaten
      updateInventoryUI();
      updatePointsUI();
      renderStationList();
      saveProgress();

      // 5) Kleines Feedback
      contentDiv.innerHTML = `
        <h2>Station ${st.id} abgeschlossen!</h2>
        <p>Du hast ${gained} Punkte erhalten.</p>
        <button id="nextBtn">‚û§ Zur√ºck zur √úbersicht</button>
      `;
      document.getElementById("nextBtn").addEventListener("click", () => {
        contentDiv.innerHTML = `<p>W√§hle eine neue Station im Men√º.</p>`;
      });
    }

    // ========================= UI-Updates: Inventar & Punkte =========================
    function updateInventoryUI() {
      // Inventar-Div leeren (au√üer Beschriftung)
      inventoryDiv.innerHTML = "<strong>Inventar:</strong>";
      inventory.forEach(itmId => {
        const span = document.createElement("span");
        span.textContent = itmId;
        inventoryDiv.appendChild(span);
      });
    }
    function updatePointsUI() {
      pointsValueEl.textContent = points.toString();
    }

    // ========================= Funktion: JSON laden (Button) =========================
    btnLoadJson.addEventListener("click", () => {
      // 1) Frage nach JSON (prompt) ‚Äì du kannst aber auch ein verstecktes <textarea> verwenden
      const userJson = prompt("Bitte f√ºge hier dein Adventure-JSON ein:");
      if (!userJson) return;

      try {
        gameData = JSON.parse(userJson);
      } catch (e) {
        return alert("Ung√ºltiges JSON!");
      }

      // 2) Titel setzen
      gameTitleEl.textContent = gameData.title || "Adventure Play";

      // 3) Initialisiere stationStates und Inventory, Punkte
      // Falls schon etwas gespeichert ist, lade das. Sonst initial
      if (!loadProgress()) {
        // Initial: Alle Stationen gesperrt, au√üer solche ohne requiresItems
        gameData.stations.forEach(st => {
          if (st.requiresItems && st.requiresItems.length > 0) {
            stationStates[st.id] = "locked";
          } else {
            stationStates[st.id] = "unlocked";
          }
        });
        inventory = [];
        points = 0;
      }

      // 4) Karte rendern
      initMap();
      placeMarkers();

      // 5) UI-Updates
      updateInventoryUI();
      updatePointsUI();
      renderStationList();
      contentDiv.innerHTML = `<p>W√§hle eine Station aus der Liste oder auf der Karte.</p>`;

      // 6) Speichern
      saveProgress();
    });

    // ========================= Funktion: Reset (Button) =========================
    btnReset.addEventListener("click", () => {
      if (confirm("Bist du sicher, dass du alles zur√ºcksetzen m√∂chtest?")) {
        clearProgress();
      }
    });

    // ========================= Beim Laden der Seite: Pr√ºfe, ob schon gespeichert =========================
    window.addEventListener("load", () => {
      // Wenn es schon Spielst√§nde im localStorage gibt, automatisch laden
      if (loadProgress() && gameData) {
        gameTitleEl.textContent = gameData.title || "Adventure Play";
        initMap();
        placeMarkers();
        updateInventoryUI();
        updatePointsUI();
        renderStationList();
        contentDiv.innerHTML = `<p>Fortsetzung deines Abenteuers!</p>`;
      }
    });
  </script>
</body>
</html>
