<!DOCTYPE html>
<head>
    <title>Gurkenflucht</title>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <link rel="stylesheet" href="style.css">

</head>

<body>

    <div id="map"></div>

    <script>

        var map = L.map('map').setView([46.9480900, 7.4474400], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        function entfernungInMetern(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function randomGurkenSpawn(lat, lon, minDist, maxDist) {
            const R = 6371000;
            const θ = Math.random() * 2 * Math.PI;
            const d = Math.sqrt(Math.random() * (maxDist**2 - minDist**2) + minDist**2);

            const δ = d / R;
            const φ1 = lat * Math.PI / 180;
            const λ1 = lon * Math.PI / 180;

            const φ2 = Math.asin(Math.sin(φ1) * Math.cos(δ) +
                                Math.cos(φ1) * Math.sin(δ) * Math.cos(θ));
            
            const λ2 = λ1 + Math.atan2(Math.sin(θ) * Math.sin(δ) * Math.cos(φ1),
                                    Math.cos(δ) - Math.sin(φ1) * Math.sin(φ2));

            const newLat = φ2 * 180 / Math.PI;
            const newLon = λ2 * 180 / Math.PI;

            return [newLat, newLon];
        }



        let vorherigeLat;
        let vorherigeLon;
        let playerLat;
        let PlayerLon;
        let player;
        let distToLastSpawn;

        navigator.geolocation.getCurrentPosition( pos => {

            player = L.circle([pos.coords.latitude, pos.coords.longitude], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 10
            }).addTo(map);  

            vorherigeLon = pos.coords.longitude -0.001;
            vorherigeLat = pos.coords.latitude -0.001;



        });

        navigator.geolocation.watchPosition( pos => {
            playerLat = pos.coords.latitude;
            playerLon = pos.coords.longitude;

            player.setLatLng([playerLat, playerLon]);

            const dLat = playerLat - vorherigeLat;
            const dLon = playerLon - vorherigeLon;

            distToLastSpawn = entfernungInMetern(vorherigeLat, vorherigeLon, playerLat, playerLon);

            console.log(distToLastSpawn);

            if (distToLastSpawn > 100) {
                console.log("Feindliche Gurken werden Gespawnt");
                vorherigeLat = playerLat;
                vorherigeLon = playerLon;

                for (let i = 0; i < 5; i++) {

                    let [gurkenLat, gurkenLon] = randomGurkenSpawn(playerLat, playerLon, 30, 100);

                    let marker = L.marker([gurkenLat, gurkenLon]).addTo(map).on('click', function(e) {

                        

                    });

                    let zielLat;
                    let ZielLon;
                    let Spielerentfernung;

                    setInterval(() => {

                            
                            
                            Spielerentfernung = entfernungInMetern(gurkenLat, gurkenLon, playerLat, playerLon);
                            if (Spielerentfernung < 60) {
                                zielLat = playerLat;
                                zielLon = playerLon;
                                intervalTime = 5;

                            } else {
                                zielLat = gurkenLat + ((Math.random() * 0.0000004) - 0.0000002);
                                zielLon = gurkenLon + ((Math.random() * 0.0000004) - 0.0000002);
                                intervalTime = 500;
                            }
                            console.log(Spielerentfernung);

                            

                            const dLat = zielLat - gurkenLat;
                            const dLon = zielLon - gurkenLon;

                            dist = Math.sqrt(dLat * dLat + dLon * dLon);

                            console.log(dist);

                            let step = 0.0000003;

                            const dirLat = dLat / dist;
                            const dirLon = dLon / dist;

                            gurkenLat += dirLat * step;
                            gurkenLon += dirLon * step;

                            marker.setLatLng([gurkenLat, gurkenLon]);

                            console.log(intervalTime);

                        }, 100)




                }
            }

            


        });




    </script>