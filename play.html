<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wandercode Play</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width:600px; margin:auto; }
    #inhalt p, #inhalt img, #inhalt audio, #inhalt button, #inhalt input {
      display: block; margin: .5rem 0;
    }
    #inhalt img { max-width:100%; }
  </style>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1 id="titel">FÃ¼ge deinen JSON-Text der Schnitzeljagd ein:</h1>
  <textarea id="textInput" rows="8" style="width:100%;" placeholder='{"title":"...","stations":[...]}'></textarea>
  <button id="startBtn" onclick="parseJSON()">JSON anwenden und schnitzeln</button>
  <button id="loadBtn" onclick="Laden()">Weitermachen</button>

  <div id="inhalt"></div>

  <script>
    let data = null, index = 0;

    function parseJSON() {
      data = JSON.parse(document.getElementById('textInput').value);
      index = 0;
      document.getElementById('titel').innerText = data.title || '';
      document.getElementById('textInput').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('loadBtn').style.display = 'none';
      Speichern();
      Abschnitt();
    }

    function Speichern() {
      localStorage.setItem("json", JSON.stringify(data));
      localStorage.setItem("id", index.toString());
    }

    function Laden() {
      const sj = localStorage.getItem("json"), si = localStorage.getItem("id");
      if (sj && si!==null) {
        data = JSON.parse(sj);
        index = parseInt(si,10);
        document.getElementById('titel').innerText = data.title||'';
        document.getElementById('textInput').style.display = 'none';
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('loadBtn').style.display = 'none';
        Abschnitt();
      } else alert("Kein Spielstand.");
    }

    function Abschnitt() {
      const c = document.getElementById('inhalt');
      c.innerHTML = '';
      if (!data||!data.stations||!data.stations[index]) {
        c.innerText = "ðŸ”š Fertig!";
        return;
      }
      const s = data.stations[index];
      if (s.imageUrl) {
        const img = document.createElement("img");
        img.src = s.imageUrl;
        c.appendChild(img);
      }
      if (s.soundUrl) {
        const au = document.createElement("audio");
        au.src = s.soundUrl;
        au.controls = true;
        c.appendChild(au);
      }
      switch(s.type) {
        case "info":    renderInfo(s,c);    break;
        case "question":renderQuestion(s,c);break;
        case "gps":     renderGPS(s,c);     break;
        default:        c.innerText="Unbekannter Typ:"+s.type;
      }
    }

    function renderInfo(st,c) {
      const p=document.createElement("p");p.innerText=st.text;c.appendChild(p);
      finishButton(c);
    }

    function renderQuestion(st,c) {
      const p=document.createElement("p");p.innerText=st.text;c.appendChild(p);
      const inp=document.createElement("input");inp.type="text";c.appendChild(inp);
      const btn=document.createElement("button");btn.innerText="Antwort prÃ¼fen";c.appendChild(btn);
      btn.onclick=()=>{
        if (inp.value.trim().toLowerCase()===st.answer.toLowerCase()) finishButton(c);
        else alert("Falsch!");
      };
    }

    function renderGPS(st,c) {
      const p=document.createElement("p");p.innerText=st.text;c.appendChild(p);
      if (navigator.geolocation) {
        const btn=document.createElement("button");btn.innerText="Position prÃ¼fen";c.appendChild(btn);
        btn.onclick=()=>{
          navigator.geolocation.getCurrentPosition(pos=>{
            const d=distance(pos.coords.latitude,pos.coords.longitude,st.lat,st.lng);
            if (d<=st.radius) finishButton(c);
            else alert(`Noch ${Math.round(d)}m entfernt.`);
          },()=>alert("GPS-Fehler"));
        };
      } else c.innerText="GPS nicht verfÃ¼gbar";
    }

    function finishButton(container) {
      container.innerHTML='';
      const msg=document.createElement("p");msg.innerText="Du hast diese Station geschafft!";container.appendChild(msg);
      const btn=document.createElement("button");btn.innerText="Weiter";container.appendChild(btn);
      btn.onclick=()=>{ index++; Speichern(); Abschnitt(); };
    }

    function distance(lat1,lon1,lat2,lon2){
      const R=6371000, r=Math.PI/180;
      const dLat=(lat2-lat1)*r, dLon=(lon2-lon1)*r;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*r)*Math.cos(lat2*r)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
  </script>
</body>
</html>
