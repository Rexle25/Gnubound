<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adventure JSON Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      font-weight: bold;
    }
    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.4rem;
      margin-bottom: 0.5rem;
      box-sizing: border-box;
    }
    textarea {
      font-family: monospace;
      height: 80px;
    }
    button {
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    fieldset {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .station-form {
      border: 1px dashed #aaa;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .station-form button.delete-station {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.2rem 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .delete-station:hover {
      background: #c0392b;
    }
    .flex-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1;
      min-width: 200px;
    }
    .map-container {
      height: 200px;
      margin-top: 0.5rem;
      border: 1px solid #ddd;
    }
    .note {
      font-size: 0.9rem;
      color: #555;
    }
    #controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    #outputJson {
      width: 100%;
      height: 200px;
      font-family: monospace;
      box-sizing: border-box;
    }
  </style>
</head>
<body>

  <h1>Adventure-JSON Generator</h1>
  <p class="note">
    Erstelle dein Abenteuer, indem du mehrere Stationen anlegst.<br>
    Jede Station beh√§lt ihre Werte, bis du sie manuell l√∂schst.<br>
    Durch Klick auf ‚ÄûJSON aktualisieren‚Äú wird das Abenteuer unten neu generiert.
  </p>

  <!-- Globale Einstellungen: Titel & Beschreibung -->
  <fieldset>
    <legend><strong>Allgemeine Einstellungen</strong></legend>
    <label for="advTitle">Titel des Abenteuers:</label>
    <input type="text" id="advTitle" placeholder="z.B. 'Die Gurkenverschw√∂rung'" />

    <label for="advDescription">Beschreibung (optional):</label>
    <textarea id="advDescription" placeholder="Kurzbeschreibung des Abenteuers"></textarea>
  </fieldset>

  <!-- Buttons: Neue Station hinzuf√ºgen & Komplett l√∂schen & JSON aktualisieren -->
  <div id="controls">
    <button id="addStationBtn">‚ûï Neue Station hinzuf√ºgen</button>
    <button id="clearAllBtn" style="background: #e74c3c; color: white;">üóëÔ∏è Alle Stationen l√∂schen</button>
    <button id="updateJsonBtn">üîÑ JSON aktualisieren</button>
  </div>

  <!-- Container f√ºr alle Station-Formulare -->
  <div id="stationFormsContainer"></div>

  <!-- Ausgabebereich: Generiertes JSON -->
  <fieldset>
    <legend><strong>Generiertes JSON</strong></legend>
    <textarea id="outputJson" readonly placeholder="JSON erscheint nach Klick auf 'üîÑ JSON aktualisieren'"></textarea>
    <p class="note">
      Kopiere das JSON und f√ºge es in deine <code>play.html</code> ein.
    </p>
  </fieldset>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    /***************************************************************************
     * Adventure-JSON Generator ‚Äì ohne Alerts
     *
     * - ‚ÄûNeue Station hinzuf√ºgen‚Äú erzeugt ein eigenes Formular-Fieldset mit Leaflet-Karte.
     * - Fehlende Eingaben werden als leere Strings oder null √ºbernommen.
     * - ‚ÄûAlle Stationen l√∂schen‚Äú leert alles, inklusive JSON-Ausgabe.
     * - ‚ÄûJSON aktualisieren‚Äú baut das finale JSON ohne Validierungs-Popups.
     ****************************************************************************/

    let stationCount = 0;            // Nummeriert die Stationen
    const mapInstances = {};         // Speichert Leaflet-Map-Instanzen (key: stationIndex)
    const markerInstances = {};      // Speichert Marker pro Station (key: stationIndex)

    // DOM-Referenzen
    const addStationBtn       = document.getElementById("addStationBtn");
    const clearAllBtn         = document.getElementById("clearAllBtn");
    const updateJsonBtn       = document.getElementById("updateJsonBtn");
    const stationFormsDiv     = document.getElementById("stationFormsContainer");
    const outputJsonArea      = document.getElementById("outputJson");
    const advTitleInput       = document.getElementById("advTitle");
    const advDescriptionInput = document.getElementById("advDescription");

    /*****************************************************************************
     * addStationForm()
     * F√ºgt ein neues Fieldset f√ºr eine Station hinzu, inklusive Leaflet-Karte.
     *****************************************************************************/
    function addStationForm() {
      stationCount++;
      const idx = stationCount;

      // Erzeuge ein Fieldset-Div mit eindeutiger ID
      const fieldset = document.createElement("fieldset");
      fieldset.classList.add("station-form");
      fieldset.id = `station-form-${idx}`;
      fieldset.innerHTML = `
        <button type="button" class="delete-station" title="Station l√∂schen">‚úñ</button>
        <h2>Station ${idx}</h2>

        <label for="stationId-${idx}">Station-ID (eindeutig):</label>
        <input type="text" id="stationId-${idx}" placeholder="z.B. 'start', 'r√§tsel1'" />

        <label for="stationType-${idx}">Stationstyp:</label>
        <select id="stationType-${idx}">
          <option value="info">Info</option>
          <option value="riddle">R√§tsel</option>
          <option value="item">Item</option>
        </select>

        <!-- Dynamische Sub-Felder je nach Stationstyp -->
        <div id="fieldsInfo-${idx}" class="sub-fields">
          <label for="stationTextInfo-${idx}">Text (Info):</label>
          <textarea id="stationTextInfo-${idx}" placeholder="Text anzeigen"></textarea>
        </div>
        <div id="fieldsRiddle-${idx}" class="sub-fields" style="display:none;">
          <label for="stationTextRiddle-${idx}">Text (R√§tsel):</label>
          <textarea id="stationTextRiddle-${idx}" placeholder="R√§tsel-Text anzeigen"></textarea>
          <label for="stationAnswerRiddle-${idx}">Antwort (Genau so eingeben):</label>
          <input type="text" id="stationAnswerRiddle-${idx}" placeholder="z.B. 'Linus Torvalds'" />
        </div>
        <div id="fieldsItem-${idx}" class="sub-fields" style="display:none;">
          <label for="stationItemName-${idx}">Item-Name (wird ins Inventar gelegt):</label>
          <input type="text" id="stationItemName-${idx}" placeholder="z.B. 'Goldener Schl√ºssel'" />
          <label for="stationItemDesc-${idx}">Item-Beschreibung (optional):</label>
          <textarea id="stationItemDesc-${idx}" placeholder="Beschreibung des Items"></textarea>
        </div>

        <!-- Gemeinsame Felder -->
        <div class="flex-row">
          <div class="flex-col">
            <label for="stationOptional-${idx}">Optionale Station?</label>
            <select id="stationOptional-${idx}">
              <option value="false">Nein (‚Üí Pflichtstation)</option>
              <option value="true">Ja (‚Üí nur Bonuspunkte)</option>
            </select>
          </div>
          <div class="flex-col">
            <label for="stationItemsGiven-${idx}">
              Items nach Abschluss (Komma-getrennt):
            </label>
            <input type="text" id="stationItemsGiven-${idx}" placeholder="z.B. 'key1,item2'" />
          </div>
          <div class="flex-col">
            <label for="stationRequiresItems-${idx}">
              Ben√∂tigte Items (Komma-getrennt):
            </label>
            <input type="text" id="stationRequiresItems-${idx}" placeholder="z.B. 'key1'" />
          </div>
        </div>

        <!-- Karte f√ºr Koordinatenauswahl -->
        <label class="map-label">
          Klicke auf die Karte, um die Position der Station festzulegen 
          (Latitude / Longitude wird √ºbernommen oder bleibt null).
        </label>
        <div id="map-${idx}" class="map-container"></div>
        <p class="note">
          Aktuell gew√§hlt: <span id="selectedCoords-${idx}">keine Koordinaten</span>
        </p>
      `;

      // F√ºge das Fieldset in den Container ein
      stationFormsDiv.appendChild(fieldset);

      // 1) Delete-Button-Funktionalit√§t
      fieldset.querySelector(".delete-station").addEventListener("click", () => {
        // Karte und Marker entfernen (falls vorhanden)
        if (mapInstances[idx]) {
          mapInstances[idx].remove();
          delete mapInstances[idx];
          delete markerInstances[idx];
        }
        // Fieldset aus DOM entfernen
        fieldset.remove();
        updateOutputJson();
      });

      // 2) Dynamische Anzeige der Sub-Felder je Stationstyp
      const typeSelect = document.getElementById(`stationType-${idx}`);
      typeSelect.addEventListener("change", () => showRelevantFields(idx));
      showRelevantFields(idx); // initial aufrufen

      // 3) Leaflet-Karte initialisieren
      const mapDiv = document.getElementById(`map-${idx}`);
      const map = L.map(mapDiv).setView([47.3769, 8.5417], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);
      mapInstances[idx] = map;

      // 4) Klick-Event: Marker setzen, Koordinaten anzeigen
      map.on("click", function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        // Marker erstellen oder verschieben
        if (markerInstances[idx]) {
          markerInstances[idx].setLatLng(e.latlng);
        } else {
          markerInstances[idx] = L.marker(e.latlng).addTo(map);
        }
        // Koordinaten-Display aktualisieren
        document.getElementById(`selectedCoords-${idx}`).textContent =
          lat.toFixed(5) + ", " + lng.toFixed(5);
        updateOutputJson();
      });

      // 5) Bei jeder √Ñnderung der Eingabefelder JSON automatisch aktualisieren
      const inputs = fieldset.querySelectorAll("input, textarea, select");
      inputs.forEach(inp => {
        inp.addEventListener("input", updateOutputJson);
      });
    }

    /*****************************************************************************
     * showRelevantFields(idx)
     * Zeigt innerhalb einer Station nur die relevanten Unterfelder an.
     *****************************************************************************/
    function showRelevantFields(idx) {
      const type = document.getElementById(`stationType-${idx}`).value;
      document.getElementById(`fieldsInfo-${idx}`).style.display   = (type === "info") ? "block" : "none";
      document.getElementById(`fieldsRiddle-${idx}`).style.display = (type === "riddle") ? "block" : "none";
      document.getElementById(`fieldsItem-${idx}`).style.display   = (type === "item") ? "block" : "none";
    }

    /*****************************************************************************
     * clearAllStations()
     * Entfernt alle Station-Fieldsets und leert das JSON-Feld.
     *****************************************************************************/
    function clearAllStations() {
      // Leaflet-Instanzen entfernen
      Object.values(mapInstances).forEach(m => m.remove());
      Object.keys(mapInstances).forEach(k => delete mapInstances[k]);
      Object.keys(markerInstances).forEach(k => delete markerInstances[k]);

      // Alle Station-Formulare l√∂schen
      stationFormsDiv.innerHTML = "";
      // JSON-Ausgabe leeren
      outputJsonArea.value = "";
      // Z√§hler zur√ºcksetzen
      stationCount = 0;
    }

    /*****************************************************************************
     * updateOutputJson()
     * Liest alle Station-Formulare aus und erzeugt das finale JSON.
     * Fehlende Eingaben werden als leere Strings oder null √ºbernommen.
     *****************************************************************************/
    function updateOutputJson() {
      const title = advTitleInput.value.trim();
      const description = advDescriptionInput.value.trim();
      const stationsArr = [];

      // F√ºr jede m√∂gliche Station (1 bis stationCount)
      for (let i = 1; i <= stationCount; i++) {
        const form = document.getElementById(`station-form-${i}`);
        if (!form) continue; // √ºberspringe gel√∂schte Stationen

        // Werte auslesen
        const idVal         = document.getElementById(`stationId-${i}`).value.trim();
        const typeVal       = document.getElementById(`stationType-${i}`).value;
        const optionalVal   = document.getElementById(`stationOptional-${i}`).value === "true";
        const itemsGivenArr = document.getElementById(`stationItemsGiven-${i}`).value
                                .split(",").map(s => s.trim()).filter(s => s);
        const requiresArr   = document.getElementById(`stationRequiresItems-${i}`).value
                                .split(",").map(s => s.trim()).filter(s => s);
        const coordsText    = document.getElementById(`selectedCoords-${i}`).textContent;

        // Koordinaten parsen ‚Äì oder null, falls nicht gesetzt
        let lat = null;
        let lng = null;
        if (coordsText && coordsText !== "keine Koordinaten") {
          const [latStr, lngStr] = coordsText.split(",").map(s => s.trim());
          const parsedLat = parseFloat(latStr);
          const parsedLng = parseFloat(lngStr);
          if (!isNaN(parsedLat) && !isNaN(parsedLng)) {
            lat = parsedLat;
            lng = parsedLng;
          }
        }

        // Basis-Objekt (leere Strings / null akzeptiert)
        const stationObj = {
          id: idVal,
          type: typeVal,
          optional: optionalVal,
          itemsGiven: itemsGivenArr,
          requiresItems: requiresArr,
          lat: lat,
          lng: lng
        };

        // Typ-spezifische Felder erg√§nzen, leere Strings werden √ºbernommen
        if (typeVal === "info") {
          stationObj.text = document.getElementById(`stationTextInfo-${i}`).value.trim();
        } else if (typeVal === "riddle") {
          stationObj.text   = document.getElementById(`stationTextRiddle-${i}`).value.trim();
          stationObj.answer = document.getElementById(`stationAnswerRiddle-${i}`).value.trim();
        } else if (typeVal === "item") {
          stationObj.itemName = document.getElementById(`stationItemName-${i}`).value.trim();
          stationObj.itemDesc = document.getElementById(`stationItemDesc-${i}`).value.trim();
        }

        // Station hinzuf√ºgen (auch wenn Felder leer oder null sind)
        stationsArr.push(stationObj);
      }

      // Gesamt-JSON zusammensetzen und anzeigen
      const result = {
        title: title,
        description: description,
        stations: stationsArr
      };
      outputJsonArea.value = JSON.stringify(result, null, 2);
    }

    // Event-Listener
    addStationBtn.addEventListener("click", () => {
      addStationForm();
      updateOutputJson(); // direktes Update
    });
    clearAllBtn.addEventListener("click", () => {
      clearAllStations();
    });
    updateJsonBtn.addEventListener("click", updateOutputJson);
  </script>
</body>
</html>
