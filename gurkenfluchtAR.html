<!DOCTYPE html>
<head>
    <title>Gurkenflucht</title>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js'></script>

    <link rel="stylesheet" href="style.css">

</head>

<body>

    

    <a-scene vr-mode-ui='enabled: false' arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 280; displayHeight: 60; videoTexture: true; debugUIEnabled: false' renderer='antialias: true; alpha: true'>
    <a-camera gps-new-camera='gpsMinDistance: 5'></a-camera>
    <a-entity material='color: green' geometry='primitive: box' gps-new-entity-place="latitude: 46.661943761175595; longitude: 7.8038544575230825" scale="30 10 10" id="gurkeEntity"></a-entity>
    </a-scene>

     


    <script>

        var map = L.map('map').setView([46.9480900, 7.4474400], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var greenIcon = L.icon({
            iconUrl: 'cucumber.png',
            shadowUrl: '',

            iconSize:     [70, 17], // size of the icon
            shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [0, 0], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        

        let lat;
        let lon;
        let random;
        let random2;
        let markerLat;
        let markerLon;
        let player;
        let gurke;
        let eingelegt;
        let beepInterval;
        let abgelenkt = false;
        let aktuellerEffekt = null;
        let entity = document.getElementById("gurkeEntity");
        const randInt = Math.floor(Math.random() * 2);
        navigator.geolocation.getCurrentPosition(

        pos => {

            lat = pos.coords.latitude;
            lon = pos.coords.longitude;

            

            const radiusInDegrees = 0.004;

            const angle = Math.random() * 2 * Math.PI;
            const distance = radiusInDegrees;

            random = Math.cos(angle) * distance;
            random2 = Math.sin(angle) * distance;


            
            markerLat = lat + random;
            markerLon = lon + random2;

            gurke = L.marker([markerLat, markerLon ], {icon: greenIcon}).addTo(map)

            player = L.circle([lat, lon], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 10
            }).addTo(map);  


        }

            


        )

        var playerLat;
        var playerLon;
        var audioPlaying;
        

        navigator.geolocation.watchPosition( pos => {


            playerLat = pos.coords.latitude;
            playerLon = pos.coords.longitude;

            player.setLatLng([playerLat, playerLon]);

        
        });
        
        var dist;
        var snd = new Audio("audio/music.mp3");
        snd.loop = true;
        

        setInterval(() => {

            

            

            const dLat = playerLat - markerLat;
            const dLon = playerLon - markerLon;

            dist = Math.sqrt(dLat * dLat + dLon * dLon);

            let step;

            if (aktuellerEffekt === "Ablenkung") {
                step = -0.0000016 + ((dist * 111000) ** 1.09) / 1110000000;
            } else if (aktuellerEffekt === "Verlangsamen") {

                step = 0.0000002 + ((dist * 111000) ** 1.01) / 1110000000;

            } else if (aktuellerEffekt === "Aufhalten") {

                step = 0.0;

            } else {
                step = 0.000016 + ((dist * 111000) ** 1.01) / 1110000000;
            }

            console.log(step);
            console.log(aktuellerEffekt);

            const dirLat = dLat / dist;
            const dirLon = dLon / dist;

            markerLat += dirLat * step;
            markerLon += dirLon * step;

            gurke.setLatLng([markerLat, markerLon]);

            entity.setAttribute("gps-new-entity-place", `latitude: ${markerLat}; longitude: ${markerLon}`);

            

            

            if (dist < 0.00010) {

                alert ("Du wurdest eingelegt");
                eingelegt = true;

            }

            if (dist < 0.0007) {
                if (!audioPlaying) {
                    snd.play();
                    audioPlaying = true;
                }
            } else {
                if (audioPlaying) {
                    snd.pause();
                    snd.currentTime = 0;
                    audioPlaying = false;
                }
            }




            

        }, 50)

        setInterval(() => {

            alert("Du hast gewonnen!")



        }, 600000)

        


    
        const types = ["Ablenkung", "Verlangsamen", "Aufhalten"]
        
    
        
        setInterval(() => {

            const randomType = types[Math.floor(Math.random() * types.length)];
            let randomItem = (Math.random() * 0.005) -0.0025;
            let random2Item = (Math.random() * 0.005) -0.0025;


            let itemLat = playerLat + randomItem;
            let itemLon = playerLon + random2Item;
            let marker = L.marker([itemLat, itemLon ]).addTo(map).on('click', function(e) {

                

                const playerDist = Math.hypot(
                    itemLat - playerLat,
                    itemLon - playerLon
                ) * 111000;

                if (playerDist < 50) {

                    if (randomType === "Ablenkung") {

                    aktuellerEffekt = randomType;

                    map.removeLayer(marker); 

                    setTimeout(() => {
                        aktuellerEffekt = null;
                        
                    }, 20000);

                    

                    } else if (randomType === "Verlangsamen") {


                        aktuellerEffekt = randomType;

                        map.removeLayer(marker); 

                        setTimeout(() => {
                            aktuellerEffekt = null;
                        }, 20000);

                    } else {

                        aktuellerEffekt = randomType;

                        map.removeLayer(marker); 

                        setTimeout(() => {
                            aktuellerEffekt = null;
                        }, 20000);

                    }

                }

                


                

            })


            
            

        }, 50000)


    </script>



</body>