<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Play</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; }
    #inhalt p, #inhalt button, #inhalt input, #inhalt img, #inhalt audio {
      display: block; margin: .5rem 0;
    }
    #textInput { width: 100%; margin-bottom: .5rem; }
  </style>

    <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1 id="titel">FÃ¼ge deinen JSON-Text der Schnitzeljagd ein:</h1>
  <input type="text" id="textInput" placeholder='{"title":"Test", "stations":[...]}'>
  <button id="jsonbutton" onclick="parseJSON()">JSON anwenden und Schnitzeljagd (neu) starten</button>
  <button id="loadbutton" onclick="Laden()">Schnitzeljagd weiterspielen</button>

  <!-- Hier rendern wir alle Stationen -->
  <div id="inhalt"></div>

  <script>
    let data = null;
    let index = 0;

    function parseJSON() {
      try {
        data = JSON.parse(document.getElementById('textInput').value);
      } catch (e) {
        return alert('UngÃ¼ltiges JSON!');
      }
      index = 0;
      document.getElementById('titel').innerText = data.title || '';
      // Eingabe-Elemente entfernen
      document.getElementById('textInput').remove();
      document.getElementById('jsonbutton').remove();
      document.getElementById('loadbutton').remove();
      Speichern();
      Abschnitt();
    }

    function Speichern() {
      localStorage.setItem("json", JSON.stringify(data));
      localStorage.setItem("id", index.toString());
    }

    function Laden() {
      const sj = localStorage.getItem("json");
      const si = localStorage.getItem("id");
      if (!sj || si === null) {
        return alert("Kein gespeicherter Spielstand gefunden.");
      }
      data = JSON.parse(sj);
      index = parseInt(si, 10);
      document.getElementById('titel').innerText = data.title || '';
      // Entferne auch die Eingabe-Widgets, falls noch da
      const ti = document.getElementById('textInput');
      const jb = document.getElementById('jsonbutton');
      const lb = document.getElementById('loadbutton');
      if (ti) ti.remove();
      if (jb) jb.remove();
      if (lb) lb.remove();
      Abschnitt();
    }

    function Abschnitt() {
      const container = document.getElementById('inhalt');
      container.innerHTML = '';  // alten Inhalt weg
      if (!data || !data.stations || !data.stations[index]) {
        return container.innerText = 'ðŸŽ‰ Alles geschafft!';
      }
      const station = data.stations[index];
      // Bild und Sound, falls vorhanden
      if (station.imageUrl) {
        const img = document.createElement('img');
        img.src = station.imageUrl;
        container.appendChild(img);
      }
      if (station.soundUrl) {
        const au = document.createElement('audio');
        au.src = station.soundUrl;
        au.controls = true;
        container.appendChild(au);
      }
      // Typ-spezifisch rendern
      switch (station.type) {
        case 'info':
          renderInfo(station, container);
          break;
        case 'question':
          renderQuestion(station, container);
          break;
        case 'gps':
          renderGPS(station, container);
          break;
        default:
          container.innerText = 'Unbekannter Typ: ' + station.type;
      }
    }

        function renderInfo(station, container) {
      // 1) Text anzeigen
      const p = document.createElement('p');
      p.innerText = station.text;
      container.appendChild(p);

      // 2) Weiter-Button erstellen
      const btn = document.createElement('button');
      btn.innerText = 'Weiter';
      container.appendChild(btn);

      // 3) Handler: erst bei Klick finish() aufrufen
      btn.onclick = () => {
        // alte Inhalte entfernen
        container.innerHTML = '';
        // Erfolgsnachricht und neuer Weiter-Button Ã¼ber finish()
        finish(container);
      };
    }



    function renderQuestion(station, container) {
      const p = document.createElement('p');
      p.innerText = station.text;
      container.appendChild(p);

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Antwort eingeben';
      container.appendChild(input);

      const btn = document.createElement('button');
      btn.innerText = 'Antwort prÃ¼fen';
      container.appendChild(btn);

      const fb = document.createElement('p');
      container.appendChild(fb);

      btn.onclick = () => {
        if (input.value.trim().toLowerCase() === station.answer.trim().toLowerCase()) {
          finish(container);
        } else {
          fb.innerText = 'Falsche Antwort. Versuchâ€™s nochmal!';
          fb.style.color = 'red';
        }
      };
    }

    function renderGPS(station, container) {
      const p = document.createElement('p');
      p.innerText = station.text;
      container.appendChild(p);

      if (!navigator.geolocation) {
        return container.appendChild(document.createTextNode('GPS nicht unterstÃ¼tzt.'));
      }

      const btn = document.createElement('button');
      btn.innerText = 'Position prÃ¼fen';
      container.appendChild(btn);

      btn.onclick = () => {
        navigator.geolocation.getCurrentPosition(pos => {
          const d = distance(
            pos.coords.latitude,
            pos.coords.longitude,
            station.lat,
            station.lng
          );
          if (d <= station.radius) {
            finish(container);
          } else {
            alert(`Du bist noch ${Math.round(d)} m entfernt.`);
          }
        }, () => alert('GPS-Fehler'));
      };
    }

    function finish(container) {
      container.innerHTML = '';
      const msg = document.createElement('p');
      msg.innerText = 'Du hast diese Station geschafft!';
      container.appendChild(msg);
      const btn = document.createElement('button');
      btn.innerText = 'Weiter';
      container.appendChild(btn);
      btn.onclick = () => {
        index++;
        Speichern();
        Abschnitt();
      };
    }

    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371000, r = Math.PI / 180;
      const dLat = (lat2 - lat1) * r;
      const dLon = (lon2 - lon1) * r;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1 * r) * Math.cos(lat2 * r) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>
</body>
</html>
